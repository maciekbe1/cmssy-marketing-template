# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **reference implementation** of a marketing site template for Cmssy - a CMS platform. It demonstrates how to structure blocks and templates for the Cmssy Marketplace. This is NOT a vendor starter kit; vendors submit code through Cmssy UI/API, and Cmssy hosts everything on their CDN.

## Build Commands

### Building Blocks

```bash
# Install dependencies (required before first build)
pnpm install

# Build all blocks
pnpm build

# Build a single block
pnpm build:block packages/blocks/hero

# Prepare CDN structure (copies dist/ to public/)
pnpm prepare-cdn
```

**Build output:** Each block's compiled code goes to `packages/blocks/{block-name}/dist/index.js` as an ESM bundle with sourcemaps.

### Code Quality

```bash
# Run ESLint
pnpm lint

# Run ESLint with auto-fix
pnpm lint:fix

# Run TypeScript type checking
pnpm type-check

# Run both linting and type checking
pnpm check
```

**Linting:** ESLint is configured with TypeScript and React plugins. Configuration in `eslint.config.js` (ESLint flat config format).

**Type checking:** TypeScript is configured in strict mode with `noEmit` to check types without compilation.

### Build Architecture

- **Builder:** ESBuild is used for all builds (`scripts/build-block.js`)
- **Format:** ESM bundles with `jsx: 'transform'` (no jsx-runtime imports)
- **React handling:** React is fully bundled into each block (not externalized) for MVP simplicity
- **CSS:** Optional CSS files at `src/index.css` are bundled separately to `dist/index.css`
- **Target:** ES2020, minified with sourcemaps

## Project Structure

### Monorepo Organization

This is a pnpm workspace with two package categories:

```
packages/
├── blocks/        # Individual UI blocks (hero, pricing, etc.)
└── templates/     # Full page templates (empty currently)
```

Each block is a standalone package with its own `package.json` containing:
- Standard npm fields (name, version, description)
- `cmssy` section with block metadata (see below)
- Build script: `"build": "node ../../../scripts/build-block.js ."`

### Block Manifest (`cmssy` section in package.json)

Every block requires a `cmssy` object in its `package.json`:

```json
{
  "cmssy": {
    "packageType": "block",
    "displayName": "Hero Section",
    "category": "marketing",
    "tags": ["hero", "landing", "cta"],
    "schemaFields": [...],
    "defaultContent": {...},
    "pricing": {
      "licenseType": "free"
    }
  }
}
```

**Important fields:**
- `schemaFields`: Array defining editable content fields (key, type, label, required, etc.)
- `defaultContent`: Default values for all schema fields
- `category`: One of: marketing, typography, media, layout, forms

**Schema field types:** string, text, number, boolean, link, image, color

### Build Scripts Flow

1. **build-block.js** - Builds a single block:
   - Locates `src/index.tsx` as entry point
   - Bundles to `dist/index.js` (ESM, minified)
   - Optionally bundles `src/index.css` if exists
   - Uses esbuild with React fully bundled

2. **build-all.js** - Orchestrates building all blocks:
   - Reads all directories in `packages/blocks/`
   - Calls `build-block.js` for each sequentially
   - Spawns child processes, inherits stdio

3. **prepare-cdn.js** - Copies built files to CDN structure:
   - Reads each block's version from `package.json`
   - Creates `public/@scope/package.name/version/` structure
   - Copies `dist/*` to versioned public directory
   - Example: `public/@cmssy/blocks.hero/1.0.0/index.js`

### Block Component Contract

All blocks export a default React component that:
- Accepts a `content` prop with user-editable fields
- Uses Tailwind CSS (available in Cmssy workspaces)
- Handles optional fields gracefully with fallbacks
- Is self-contained (no external dependencies beyond React)

Example:
```tsx
export default function HeroBlock({ content }: { content: HeroContent }) {
  const { heading = "Default", ctaUrl } = content;
  return <section>...</section>;
}
```

## Deployment

### Self-Hosting (Optional)

The `public/` directory generated by `pnpm build` can be deployed to:
- Vercel (configured in `vercel.json`)
- Cloudflare Pages
- AWS S3 + CloudFront
- Netlify

**Vercel configuration highlights:**
- Build command: `pnpm build`
- Output directory: `public`
- CORS enabled (`Access-Control-Allow-Origin: *`)
- Immutable caching (`max-age=31536000`)

### Marketplace Submission (Recommended)

Vendors submit blocks through Cmssy UI/API. Cmssy handles:
- Code review and approval
- CDN hosting and distribution
- Versioning and updates
- Payment processing (80/20 revenue split)

## Development Workflow

When adding a new block:

1. Create directory: `packages/blocks/{block-name}/`
2. Add `package.json` with proper `cmssy` metadata
3. Create `src/index.tsx` with React component
4. Optionally add `src/index.css`
5. Run `pnpm check` to verify code quality (lint + type-check)
6. Build: `pnpm build:block packages/blocks/{block-name}`
7. Test output in `dist/`
8. Run `pnpm prepare-cdn` to generate CDN structure

## Important Constraints

- **Node.js**: Requires 18+ (specified in package.json engines)
- **pnpm**: Requires 8+ (workspace features)
- **React version**: Blocks support React 18 or 19 (peerDependencies)
- **Code quality**: ESLint and TypeScript configured with strict mode
- **No tests**: No test framework configured currently
